apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: firefly-iii
  namespace: firefly
spec:
  interval: 1m
  chart:
    spec:
      chart: firefly-iii-stack
      version: 0.7.3
      sourceRef:
        kind: HelmRepository
        name: firefly-iii
        namespace: flux-system
  values:
    firefly-db:
      enabled: true

      image:
        repository: postgres
        tag: 14-alpine
        pullPolicy: IfNotPresent
      
      storage:
        class: longhorn
        accessModes: ReadWriteOnce
        dataSize: 5Gi
        
      backup:
        destination: pvc
        pvc:
          class: longhorn
          accessModes: ReadWriteOnce
          dataSize: 5Gi
      backupSchedule: "0 3 * * *"
      
      configs:
        RESTORE_URL: ""
        BACKUP_URL: ""
        DBHOST: firefly-iii-firefly-db
        DBPORT: "5432"
        DBNAME: firefly
        TZ: Europe/Lisbon
        existingSecret: db-secret
      
    firefly-iii:
      enabled: true

      image:
        repository: "fireflyiii/core"
        pullPolicy: IfNotPresent
        tag: version-6.1.1

      persistence:
        enabled: true
        storageClassName: longhorn
        accessModes: ReadWriteOnce
        storage: 5Gi
      
      # -- Environment variables for Firefly III. See docs at: https://github.com/firefly-iii/firefly-iii/blob/      main/.env.example
      config:
        existingSecret: app-secret
        
        env:
          DB_HOST: firefly-iii-firefly-db
          DB_CONNECTION: pgsql
          DB_PORT: "5432"
          DB_DATABASE: firefly
          DEFAULT_LANGUAGE: "en_US"
          DEFAULT_LOCALE: "equal"
          TZ: "Europe/Lisbon"
          TRUSTED_PROXIES: "**"
          APP_URL: "https://budget.nmoura.pt"
          MAIL_HOST: oauthmail-2465.tools.svc.cluster.local
          MAIL_PORT: "2465"
          MAIL_ENCRYPTION: "null"

      
      # -- A cronjob for [recurring Firefly III tasks](https://docs.firefly-iii.org/firefly-iii/      advanced-installation/cron/).
      cronjob:
        # -- Set to true to enable the CronJob. Note that you need to specify either cronjob.auth.existingSecret or       cronjob.auth.token for it to actually be deployed.
        enabled: false
        # -- Authorization for the CronJob. See https://docs.firefly-iii.org/firefly-iii/advanced-installation/cron/      #request-a-page-over-the-web
        auth:
          # -- The name of a secret containing a data.token field with the cronjob token
          existingSecret: ""
          # -- The name of the key in the existing secret to get the cronjob token from
          secretKey: "token"
          # -- The token in plain text
          token: ""
        # -- When to run the CronJob. Defaults to 03:00 as this is when Firefly III executes regular tasks.
        schedule: "0 3 * * *"
        # -- How many pods to keep around for successful jobs
        successfulJobsHistoryLimit: 3
        # -- How many pods to keep around for failed jobs
        failedJobsHistoryLimit: 1
        # -- How to treat failed jobs
        restartPolicy: OnFailure
        image:
          repository: curlimages/curl
          pullPolicy: IfNotPresent
          tag: 7.81.0
      
      service:
        type: ClusterIP
        port: 80
      
      ingress:
        enabled: true
        ingressClassName: traefik
        hosts:
          - budget.nmoura.pt
        paths:
          - /
        tls: 
        - secretName: nmoura-pt-tls
          hosts:
          - budget.nmoura.pt
      
    importer:
      enabled: false