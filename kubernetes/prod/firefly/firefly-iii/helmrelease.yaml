apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: firefly-iii
  namespace: firefly
spec:
  interval: 1m
  chart:
    spec:
      chart: firefly-iii-stack
      version: 0.7.3
      sourceRef:
        kind: HelmRepository
        name: firefly-iii
        namespace: flux-system
  values:
    firefly-db:
      enabled: true
      
      storage:
        class: longhorn
        accessModes: ReadWriteOnce
        dataSize: 5Gi
        
      backup:
        destination: pvc
        pvc:
          class: longhorn
          accessModes: ReadWriteOnce
          dataSize: 5Gi
      backupSchedule: "0 3 * * *"
      
      configs:
        RESTORE_URL: ""
        BACKUP_URL: ""
        PGPASSWORD: ""
        DBHOST: firefly-iii-firefly-db
        DBPORT: "5432"
        DBNAME: firefly
        DBUSER: firefly
        TZ: Europe/Amsterdam
        POSTGRES_HOST_AUTH_METHOD: trust
        POSTGRES_USER: firefly
        POSTGRES_PASSWORD: ""
          # -- Set this to the name of a secret to load environment variables from. If defined, values in the       secret will override values in configs
        existingSecret: ""
      
    firefly-iii:
      enabled: true
      persistence:
        enabled: true
        storageClassName: longhorn
        accessModes: ReadWriteOnce
        storage: 5Gi
      
      # -- Environment variables for Firefly III. See docs at: https://github.com/firefly-iii/firefly-iii/blob/      main/.env.example
      config:
        # -- Set this to the name of a secret to load environment variables from. If defined, values in the secret       will override values in config.env
        existingSecret: ""
        # -- Directly defined environment variables. Use this for non-secret configuration values.
        env:
          DB_HOST: "firefly-iii-firefly-db"
          # DB_CONNECTION: pgsql
          # DB_PORT: "5432"
          # DB_DATABASE: firefly
          # DB_USERNAME: firefly
          DEFAULT_LANGUAGE: "en_US"
          DEFAULT_LOCALE: "equal"
          TZ: "Europe/Lisbon"
          TRUSTED_PROXIES: "**"
      
      # -- Create a new Secret from values file to store sensitive environment variables. Make sure to keep your       secrets encrypted in the repository! For example, you can use the 'helm secrets' plugin (https://github.com/      jkroepke/helm-secrets) to encrypt and manage secrets. If the 'config.existingSecret' value is set, a new       Secret will not be created.
      secrets:
        env:
          APP_PASSWORD: "firefly"
          DB_PASSWORD: "firefly"
        # -- Statically set the APP_KEY in case this is desired over the autogeneration. Should be a random       32-character string.
        # -- Can be generated using: `cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 32 | head -n 1`
          APP_KEY: "WK0yo9chi2tqVrVZVtMaJZ9qNzs8K0ux"
      
      # -- A cronjob for [recurring Firefly III tasks](https://docs.firefly-iii.org/firefly-iii/      advanced-installation/cron/).
      cronjob:
        # -- Set to true to enable the CronJob. Note that you need to specify either cronjob.auth.existingSecret or       cronjob.auth.token for it to actually be deployed.
        enabled: false
        # -- Authorization for the CronJob. See https://docs.firefly-iii.org/firefly-iii/advanced-installation/cron/      #request-a-page-over-the-web
        auth:
          # -- The name of a secret containing a data.token field with the cronjob token
          existingSecret: ""
          # -- The name of the key in the existing secret to get the cronjob token from
          secretKey: "token"
          # -- The token in plain text
          token: ""
        # -- When to run the CronJob. Defaults to 03:00 as this is when Firefly III executes regular tasks.
        schedule: "0 3 * * *"
        # -- How many pods to keep around for successful jobs
        successfulJobsHistoryLimit: 3
        # -- How many pods to keep around for failed jobs
        failedJobsHistoryLimit: 1
        # -- How to treat failed jobs
        restartPolicy: OnFailure
        image:
          repository: curlimages/curl
          pullPolicy: IfNotPresent
          tag: 7.81.0
      
      service:
        type: ClusterIP
        port: 80
      
      ingress:
        enabled: true
        ingressClassName: traefik
        hosts:
          - budget.nmoura.pt
        paths:
          - /
        tls: 
        - secretName: nmoura-pt-tls
          hosts:
          - budget.nmoura.pt
      
    importer:
      enabled: false